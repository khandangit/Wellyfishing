<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Fishing Spots in Wellington</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      background-color: #2c3e50;
      color: white;
      padding: 1em;
      text-align: center;
      font-size: clamp(1.2em, 4vw, 1.5em);
    }

    #search-container {
      position: relative;
      width: 100%;
      padding: 12px;
      box-sizing: border-box;
    }

    #search {
      width: 100%;
      padding: 12px;
      font-size: clamp(0.9em, 3vw, 1em);
      border: none;
      border-radius: 25px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: box-shadow 0.3s ease-in-out;
      box-sizing: border-box;
    }

    #search:hover {
      box-shadow: 0 2px 15px rgba(0,0,0,0.2);
    }

    #search:focus {
      outline: none;
      border: 2px solid #FFDD00;
    }

    #spotList {
      position: absolute;
      top: 60px;
      left: 12px;
      right: 12px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .spot {
      padding: 12px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      font-size: clamp(0.85em, 2.5vw, 0.9em);
      line-height: 1.4;
      min-height: 44px;
    }

    .spot:last-child {
      border-bottom: none;
    }

    .spot:hover, .spot:focus {
      background-color: #f2f2f2;
      outline: none;
    }

    #map {
      flex: 1;
      min-height: 50vh;
      margin-top: 10px;
      position: relative;
    }

    #tide-info {
      position: absolute;
      top: 60px;
      right: 10px;
      z-index: 1002;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
      font-size: clamp(0.8em, 2.5vw, 0.9em);
      display: none;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      max-width: 200px;
    }

    #tide-info .credit {
      margin-top: 8px;
      font-size: clamp(0.7em, 2vw, 0.75em);
      color: #555;
    }

    #tide-toggle, #snapper-toggle, #kingfish-toggle, #kahawai-toggle, #redcod-toggle {
      position: absolute;
      z-index: 1001;
      background-color: #FFDD00;
      color: #000;
      border: none;
      border-radius: 5px;
      padding: 8px;
      cursor: pointer;
      font-size: clamp(0.85em, 2.5vw, 0.9em);
      min-height: 44px;
      line-height: 1;
      display: flex;
      align-items: center;
    }

    #tide-toggle {
      top: 10px;
      right: 10px;
    }

    #snapper-toggle {
      top: 60px;
      right: 10px;
    }

    #kingfish-toggle {
      top: 110px;
      right: 10px;
    }

    #kahawai-toggle {
      top: 160px;
      right: 10px;
    }

    #redcod-toggle {
      top: 210px;
      right: 10px;
    }

    #tide-toggle:hover, #snapper-toggle:hover, #kingfish-toggle:hover, #kahawai-toggle:hover, #redcod-toggle:hover {
      background-color: #e6c700;
    }

    #tide-toggle.off, #snapper-toggle.off, #kingfish-toggle.off, #kahawai-toggle.off, #redcod-toggle.off {
      background-color: #ccc;
      color: #333;
    }

    #tide-toggle.off:hover, #snapper-toggle.off:hover, #kingfish-toggle.off:hover, #kahawai-toggle.off:hover, #redcod-toggle.off:hover {
      background-color: #b3b3b3;
    }

    .leaflet-control-legend {
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      font-size: clamp(0.8em, 2.5vw, 0.9em);
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      margin-right: 8px;
      border: 1px solid #333;
    }

    footer {
      background: #f4f4f4;
      padding: 1em;
      font-size: clamp(0.75em, 2.5vw, 0.8em);
    }

    #caution {
      background: #fff8c4;
      padding: 8px;
      border-left: 5px solid #f1c40f;
      margin-bottom: 1em;
      font-size: clamp(0.7em, 2.5vw, 0.8em);
    }

    #donate-button {
      display: inline-block;
      margin-top: 10px;
      background-color: #FFDD00;
      color: #000;
      padding: 6px 10px;
      border-radius: 5px;
      font-weight: bold;
      text-decoration: none;
      font-size: clamp(0.7em, 2.5vw, 0.8em);
      min-height: 44px;
      line-height: 44px;
    }

    footer a {
      color: #0055aa;
      text-decoration: underline;
    }

    footer p.developer {
      font-size: clamp(0.65em, 2vw, 0.75em);
    }

    #disclaimer {
      font-size: clamp(0.65em, 2vw, 0.75em);
    }

    #submit-spot-form {
      margin-top: 1em;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #submit-spot-form label {
      font-weight: bold;
      font-size: clamp(0.75em, 2.5vw, 0.8em);
    }

    #submit-spot-form input,
    #submit-spot-form textarea,
    #submit-spot-form select {
      padding: 8px;
      font-size: clamp(0.85em, 2.5vw, 0.9em);
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;
      box-sizing: border-box;
      min-height: 44px;
    }

    #submit-spot-form textarea {
      resize: vertical;
      min-height: 80px;
    }

    #submit-spot-form button {
      background-color: #FFDD00;
      color: #000;
      padding: 10px;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      font-size: clamp(0.85em, 2.5vw, 0.9em);
      min-height: 44px;
    }

    #submit-spot-form button:hover {
      background-color: #e6c700;
    }

    #back-to-top {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #FFDD00;
      color: #000;
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1.2em;
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    #back-to-top:hover {
      background-color: #e6c700;
    }

    #confirmation-message {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      z-index: 1002;
      font-size: clamp(0.85em, 2.5vw, 0.9em);
      display: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* Tablet and small desktop */
    @media (max-width: 768px) {
      #map {
        min-height: 400px;
      }
      #spotList {
        top: 55px;
        max-height: 150px;
      }
      header {
        padding: 0.8em;
      }
      #search-container {
        padding: 8px;
      }
      #submit-spot-form input,
      #submit-spot-form textarea,
      #submit-spot-form select {
        font-size: 0.9em;
      }
      #submit-spot-form button {
        font-size: 0.9em;
      }
      #tide-toggle, #snapper-toggle, #kingfish-toggle, #kahawai-toggle, #redcod-toggle {
        font-size: 0.9em;
        padding: 6px;
      }
      .leaflet-control-legend {
        font-size: 0.9em;
        padding: 8px;
      }
    }

    /* Small mobile devices */
    @media (max-width: 480px) {
      #map {
        min-height: 300px;
      }
      #spotList {
        top: 50px;
        left: 8px;
        right: 8px;
        max-height: 120px;
      }
      #search {
        padding: 10px;
        font-size: 0.9em;
      }
      header {
        font-size: 1.2em;
        padding: 0.6em;
      }
      #search-container {
        padding: 6px;
      }
      .spot {
        padding: 10px;
        font-size: 0.85em;
      }
      footer {
        padding: 0.8em;
      }
      #submit-spot-form input,
      #submit-spot-form textarea,
      #submit-spot-form select {
        font-size: 0.85em;
      }
      #submit-spot-form button {
        font-size: 0.85em;
      }
      #tide-toggle, #snapper-toggle, #kingfish-toggle, #kahawai-toggle, #redcod-toggle {
        font-size: 0.85em;
        padding: 5px;
      }
      #confirmation-message {
        top: 10px;
        right: 10px;
        padding: 8px 15px;
        font-size: 0.85em;
      }
      .leaflet-control-legend {
        font-size: 0.85em;
        padding: 6px;
      }
    }
  </style>
</head>
<body>

  <header>
    Fishing Spots in Wellington
  </header>

  <div id="search-container">
    <input
      type="text"
      id="search"
      placeholder="Search for a fishing spot..."
      aria-label="Search for fishing spots in Wellington"
      onkeyup="filterSpots()"
    >
    <div id="spotList" role="dialog" aria-label="Search results"></div>
  </div>

  <div id="map" role="region" aria-label="Map of fishing spots in Wellington">
    <button id="tide-toggle" aria-label="Turn tide information off">Tide Info On</button>
    <button id="snapper-toggle" aria-label="Turn Snapper distribution off">Snapper Dist On</button>
    <button id="kingfish-toggle" aria-label="Turn Kingfish distribution off">Kingfish Dist On</button>
    <button id="kahawai-toggle" aria-label="Turn Kahawai distribution off">Kahawai Dist On</button>
    <button id="redcod-toggle" aria-label="Turn Red Cod distribution off">Red Cod Dist On</button>
    <div id="tide-info">
      <strong id="tide-title">Tides at Selected Location:</strong><br>
      <span id="tide-data">Click map to load tide data...</span>
      <div class="credit">
        Tide data provided by <a href="https://tides.niwa.co.nz/" target="_blank" aria-label="Visit NIWA Tide Forecaster website">NIWAâ€™s Tide Forecaster</a>
      </div>
    </div>
  </div>

  <footer>
    <div id="caution">
      <strong>Caution: 
      </p> Fishing conditions can change rapidly, and the information provided may not always be current or accurate due to its community-sourced nature. </p> Always check local weather, tides, and regulations before fishing as they may change.</strong><br></p>For more info:
      <ul>
        <li><a href="https://apps.apple.com/nz/app/nz-fishing-rules/id456121901" target="_blank">NZ Fishing Rules App (iOS)</a></li>
        <li><a href="https://play.google.com/store/apps/details?id=nz.govt.fish&pli=1" target="_blank">NZ Fishing Rules App (Android)</a></li>
        <li><a href="https://www.mpi.govt.nz/fishing-aquaculture/recreational-fishing/fishing-rules/" target="_blank">Fishing Rules on MPI Website</a></li>
      </ul>
    </div>

    <p class="developer">Developed by Hank. For any tips, suggestions, correction or adding new spots, please fill the below form or Contact: <a href="mailto:khandangithub@gmail.com">khandangithub@gmail.com</a></p>

    <form id="submit-spot-form">
      <h3>Submit a New Fishing Spot</h3>
      <label for="spot-name">Spot Name:</label>
      <input type="text" id="spot-name" required aria-label="Name of the fishing spot">
      <label for="spot-coords">Coordinates (Lat, Lon):</label>
      <input type="text" id="spot-coords" placeholder="e.g., -41.3477, 174.7419" required aria-label="Coordinates (latitude, longitude)">
      <label for="spot-fish">Fish Types:</label>
      <input type="text" id="spot-fish" placeholder="e.g., Kahawai, Snapper" required aria-label="Types of fish at the spot">
      <label for="spot-tips">Tips:</label>
      <textarea id="spot-tips" required aria-label="Fishing tips for the spot"></textarea>
      <label for="spot-season">Best Season:</label>
      <select id="spot-season" required aria-label="Best season for fishing at the spot">
        <option value="All Year Round">All Year Round</option>
        <option value="Spring to Summer">Spring to Summer</option>
        <option value="Summer to Autumn">Summer to Autumn</option>
        <option value="Autumn to Winter">Autumn to Winter</option>
        <option value="Winter to Spring">Winter to Spring</option>
      </select>
      <button type="submit">Submit Spot</button>
    </form>

    <div id="disclaimer">
      <strong>Disclaimer:</strong><br>
      The information provided on this site is gathered from general knowledge, community contributions, and public resources for guideline purposes only. While we make every effort to ensure accuracy, we are not responsible for any errors, omissions, or consequences that may arise from the use of this information. 
      Users are strongly advised to verify all fishing rules, safety precautions, and local regulations before engaging in any activities. Please check with relevant authorities for the most up-to-date and accurate information. 
      Use of this site and its information is at your own risk.
    </div>
  </footer>

  <button id="back-to-top" aria-label="Back to top">â†‘</button>
  <div id="confirmation-message">Submission sent! Check your email client.</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    const map = L.map('map', {
      zoomControl: true,
      scrollWheelZoom: true,
      touchZoom: true,
      doubleClickZoom: true
    }).setView([-41.313, 174.77], 11);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    // Fish-to-URL mapping
    const fishLinks = {
      "Kahawai": "https://www.seafood.co.nz/species/kahawai/",
      "Snapper": "https://www.seafood.co.nz/species/snapper/",
      "Gurnard": "https://www.fishing.net.nz/fishing-advice/fishing-hints-tips-and-how-to-articles/catching-gurnard-top-tips/",
      "Blue Cod": "https://www.seafood.co.nz/species/blue-cod/",
      "Red Cod": "https://www.seafood.co.nz/species/red-cod/",
      "Spotty Sharks": "https://en.wikipedia.org/wiki/Spotted_estuary_smooth-hound",
      "Banded wrasse (Kelpie)": "https://www.fishspecies.nz/search/",
      "Elephant Fish": "https://www.seafood.co.nz/species/elephant-fish/",
      "Trevally": "https://www.seafood.co.nz/species/trevally/",
      "Tarakihi": "https://www.seafood.co.nz/species/tarakihi/",
      "Kingfish": "https://www.seafood.co.nz/species/yellowtail-kingfish/",
      "Moki": "https://www.seafood.co.nz/species/blue-moki/",
      "Skate": "https://www.seafood.co.nz/species/rays-and-skates/",
      "Blue Moki": "https://www.seafood.co.nz/species/blue-moki/",
      "Butterfish": "https://www.fishspecies.nz/search/"
    };

    // Function to generate hyperlinked fish names
    function getLinkedFish(fishString) {
      return fishString.split(',').map(fish => {
        const trimmedFish = fish.trim();
        const url = fishLinks[trimmedFish] || 'https://www.fishspecies.nz/search/';
        return `<a href="${url}" target="_blank" rel="noopener">${trimmedFish}</a>`;
      }).join(', ');
    }

    const spots = [
      {
        name: "Owhiro Bay", 
        coords: [-41.359347, 174.720130],
        fish: "Kahawai, Snapper, Gurnard, Blue Cod, Red Cod, Spotty Sharks, Banded wrasse (Kelpie), Elephant Fish",
        tips: "Fish during rising tide, early morning, or change of light for best results. Park at the quarry car park, walk past the reserve, around the first point, past the first houses, and 200m further to a small sandy bay with a reef 80m out. Use 4-5oz breakaway, pulley rig, or ledger with pilchard, squid, or bonito bait, bound with bait elastic. Ideal in small or no swell with light northerly winds; strong northerlies are unpleasant. Use 30-40 kg terminal trace and circle hooks due to sharks. Note: Close to Taputeranga Marine Reserve; ensure you're outside restricted areas.",
        season: "Autumn to Winter"
      },
      {
        name: "Makara Beach",
        coords: [-41.21972222, 174.7122222],
        fish: "Blue Cod, Tarakihi, Snapper, Kahawai, Trevally, Red Cod, Spotty Sharks, Kingfish, Moki",
        tips: "Best fished Februaryâ€“June during early morning or late evening on a rising tide. Use 10â€“12 ft surf rods, long-cast reels, 4/0â€“5/0 hooks, and firm bait like squid, pilchard, or shellfish. Berley improves catch rates, especially for kahawai and kingfish. Fish from the rocky shoreline or right-side ledge at low tide for snapper. Use ledger rigs with crab or cray bait for spotty sharks. Kayak fishing and softbaits effective offshore. Check weather, as strong winds can make fishing difficult.",
        season: "Late Summer to Spring"
      },
      {
        name: "Red Rocks",
        coords: [-41.341040, 174.677150],
        fish: "Blue Moki, Butterfish, Blue Cod, Kahawai, Moki",
        tips: "Accessible via a coastal walk past Devilâ€™s Gate, this area is ideal for blue moki in winter and butterfish. Fish during incoming tides with pilchards or squid bait. Wear warm clothing due to exposed conditions and avoid southerly winds. Use stronger tackle due to rocky terrain. Ensure fishing is outside Taputeranga Marine Reserve boundaries.",
        season: "Spring to Summer"
      },
      {
        name: "Lyall Bay",
        coords: [-41.335447, 174.803694],
        fish: "Kahawai, Gurnard",
        tips: "Popular among surfcasters, Lyall Bay is ideal for catching kahawai and gurnard. Fish during incoming tides with pilchards or squid bait for best results. Due to rocky terrain, use stronger tackle to prevent line breakage. Check weather forecasts, as the South Coast can be exposed to strong winds.",
        season: "Summer"
      },
      {
        name: "Breaker Bay",
        coords: [-41.3299, 174.8344],
        fish: "Blue Cod, Tarakihi, Kahawai, Kingfish",
        tips: "Target slack tide with fresh bait near rocky outcrops for blue cod and tarakihi. Beach fishing is effective in northerly winds, as the hill reduces wind impact. Soft baits work well two hours before dusk. Kingfish up to 25-30lb have been caught on hex wobblers.",
        season: "Spring to Summer"
      },
      {
        name: "Scorching Bay",
        coords: [-41.2970, 174.8333],
        fish: "Snapper, Trevally, Kahawai",
        tips: "Fish near the rocks at dawn for snapper, trevally, and kahawai. Use pilchards or squid bait during incoming tides. Benefits from proximity to deeper waters near the harbour entrance, making it productive year-round.",
        season: "All Year Round"
      },
      {
        name: "Seatoun",
        coords: [-41.3247, 174.8380],
        fish: "Kahawai, Snapper, Skate",
        tips: "Fish during incoming tide with pilchard bait from Seatoun Wharf for kahawai, snapper, and skate. The wharfâ€™s deep waters near the harbour entrance make it reliable year-round. Recent reports confirm good snapper catches.",
        season: "Spring to Summer"
      },
      {
        name: "Oriental Bay",
        coords: [-41.2910, 174.7940],
        fish: "Kahawai, Snapper, Trevally",
        tips: "A favorite for shore fishing, Oriental Bayâ€™s wharves and jetties offer easy access. Fish during incoming tides with pilchards or squid bait for kahawai, snapper, and trevally. Best from late spring to early autumn. Popular spot, so arrive early to avoid crowds.",
        season: "Summer to Autumn"
      },
      {
        name: "Evans Bay",
        coords: [-41.300383, 174.805366], 
        fish: "Gurnard, Tarakihi, Kahawai",
        tips: "Known for calm waters near the airport, Evans Bay is ideal for gurnard and tarakihi. Fish during incoming tides in deeper parts with pilchards or squid bait. Best in warmer months. Suitable for shore fishing with light tackle.",
        season: "Summer to Autumn"
      },
      {
        name: "Mana Bridge, N side",
        coords: [-41.0975, 174.796683], 
        fish: "Snapper",
        tips: "Boat fishing, Outgoing tide only",
        season: "Summer to Autumn"
      },
      {
        name: "Petone Wharf",
        coords: [-41.229998, 174.869941], 
        fish: "Kahawai, Snapper, Kingfish",
        tips: "This historic wharf offers ample space for anglers. Fish during incoming tides with pilchards or squid bait for kahawai, snapper, and occasional kingfish. Best from late spring to early autumn. Use stronger tackle in deeper waters for kingfish.",
        season: "Summer to Autumn"
      },
      {
        name: "Muritai Beach",
        coords: [-41.3011, 174.8886],
        fish: "Trevally, Gurnard",
        tips: "Fish near the rocks in the evening for trevally and gurnard. Limited specific details are available, but the beach is accessible for shore fishing, with a boat ramp nearby. Kina are present, suggesting potential for other species. Verify conditions due to limited data.",
        season: "Summer to Autumn"
      },
      {
        name: "Days Bay",
        coords: [-41.2806, 174.9052],
        fish: "Snapper, Kahawai",
        tips: "Use soft baits during high tide for snapper and kahawai. Nearby Sunshine Bay is productive in spring/summer, and Rona Bay Wharf is a less crowded spot. Sheltered bays enhance fishing opportunities year-round.",
        season: "All Year Round"
      },
      {
        name: "Te Raekaihau Point",
        coords: [-41.3426, 174.7917],
        fish: "Kingfish, Snapper, Blue Cod",
        tips: "Fish near rock pools early in the morning for kingfish, snapper, and blue cod. Use pilchards or squid bait during incoming tides. Ensure youâ€™re outside Taputeranga Marine Reserve boundaries. Check weather due to exposed conditions.",
        season: "Spring to Summer"
      },
      {
        name: "Shelly Bay",
        coords: [-41.2969, 174.8212],
        fish: "Snapper, Trevally, Kahawai",
        tips: "Fish from the wharf early in the morning with pilchards or squid bait for snapper, trevally, and kahawai. The northern end near Chocolate Fish Cafe is snag-free and ideal for kahawai. Avoid crowds by fishing early. Reliable year-round.",
        season: "All Year Round"
      },
      {
        name: "Wairaka Rock (Pukerua Bay)",
        coords: [-41.030530, 174.871348],
        fish: "Snapper, Kahawai, Kingfish, Trevally",
        tips: "Access via a path and fish near the rock outcrop. The area is rocky with foul ground, so use a minimum 30lb line and strayline or a 1/2 oz sinker. Big kingfish and snapper have been caught here, with abundant piper and pilchard for fresh bait. Kahawai and trevally are common; bring burley and sabiki flies. Avoid fishing if the swell exceeds 1.5 meters due to safety concerns.",
        season: "Spring to Summer"
      }
    ];

    function addMarker(spot) {
      L.marker(spot.coords).addTo(map)
        .bindPopup(`<strong>${spot.name}</strong><br><em>Fish:</em> ${getLinkedFish(spot.fish)}<br><em>Tips:</em> ${spot.tips}<br><em>Best Season:</em> ${spot.season}`);
    }

    spots.forEach(spot => addMarker(spot));

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    const filterSpots = debounce(function() {
      const searchQuery = document.getElementById('search').value.toLowerCase();
      const spotListDiv = document.getElementById('spotList');
      spotListDiv.innerHTML = '';

      if (searchQuery.length === 0) {
        spotListDiv.style.display = 'none';
        spotListDiv.setAttribute('aria-hidden', 'true');
        return;
      }

      const filteredSpots = spots.filter(spot => spot.name.toLowerCase().includes(searchQuery));
      filteredSpots.forEach(spot => {
        const spotDiv = document.createElement('div');
        spotDiv.classList.add('spot');
        spotDiv.setAttribute('tabindex', '0');
        spotDiv.setAttribute('role', 'button');
        spotDiv.setAttribute('aria-label', `View details for ${spot.name}`);
        spotDiv.innerHTML = `<div><strong>${spot.name}</strong><br><em>Fish:</em> ${getLinkedFish(spot.fish)}<br><em>Best Season:</em> ${spot.season}</div>`;
        spotDiv.onclick = () => selectSpot(spot);
        spotDiv.onkeydown = (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            selectSpot(spot);
          }
        };
        spotListDiv.appendChild(spotDiv);
      });
      spotListDiv.style.display = 'block';
      spotListDiv.setAttribute('aria-hidden', 'false');
    }, 300);

    function selectSpot(spot) {
      map.setView(spot.coords, 14);
      L.popup()
        .setLatLng(spot.coords)
        .setContent(`
          <strong>${spot.name}</strong><br>
          <em>Fish:</em> ${getLinkedFish(spot.fish)}<br>
          <em>Tips:</em> ${spot.tips}<br>
          <em>Best Season:</em> ${spot.season}
        `)
        .openOn(map);
      document.getElementById('spotList').style.display = 'none';
      document.getElementById('spotList').setAttribute('aria-hidden', 'true');
    }

    const reserveCoords = [
      [-41.3435, 174.7445],
      [-41.3666, 174.7445],
      [-41.3666, 174.7895],
      [-41.3425, 174.7895]
    ];
    const reserve = L.polygon(reserveCoords, {
      color: 'red',
      weight: 2,
      fillOpacity: 0.3
    }).addTo(map);
    reserve.bindPopup('Marine Reserve - No fishing allowed here.');

    const wellingtonBounds = L.latLngBounds(
      [-41.392729, 174.458771],
      [-41.101102, 175.363523]
    );
    map.fitBounds(wellingtonBounds);

    document.getElementById('search').addEventListener('input', filterSpots);

    // Back-to-top button functionality
    const backToTopButton = document.getElementById('back-to-top');
    window.addEventListener('scroll', () => {
      if (window.scrollY > 200) {
        backToTopButton.style.display = 'block';
      } else {
        backToTopButton.style.display = 'none';
      }
    });
    backToTopButton.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // Tide data fetch function
    function fetchTideData(lat, long) {
      const tideDataSpan = document.getElementById('tide-data');
      const tideTitle = document.getElementById('tide-title');
      const url = `https://api.niwa.co.nz/tides/data?lat=${lat}&long=${long}&numberOfDays=1&startDate=2025-04-24`;
      const encodedApiKey = 'ZzZ3UGFMVUFQYXM4WUh4TlE0Tk9YVVNFd3Vsd05OcXk=';
      const apiKey = atob(encodedApiKey);

      tideTitle.innerHTML = `Tides at ${lat.toFixed(4)}, ${long.toFixed(4)}:`;
      tideDataSpan.innerHTML = 'Loading tide data...';

      fetch(url, {
        headers: {
          'x-apikey': apiKey
        }
      })
        .then(response => {
          if (response.status === 401) {
            console.error('Tide API: Invalid API key');
            tideDataSpan.innerHTML = 'Invalid tide API key. Please check your API key configuration.';
            return null;
          }
          if (response.status === 429) {
            console.error('Tide API: Rate limit exceeded');
            tideDataSpan.innerHTML = 'Tide API rate limit exceeded. Try again later.';
            return null;
          }
          if (!response.ok) {
            console.error(`Tide API error: ${response.status}`);
            tideDataSpan.innerHTML = 'Tide data unavailable for this location. Try a coastal area.';
            return null;
          }
          return response.json();
        })
        .then(data => {
          if (!data || !data.values) {
            console.error('Tide API: No tide data returned');
            tideDataSpan.innerHTML = 'No tide data available. Try a coastal area.';
            return;
          }
          const tides = data.values.slice(0, 4).map(tide => {
            const time = new Date(tide.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            return `Height: ${tide.value.toFixed(2)}m at ${time}`;
          }).join('<br>');
          tideDataSpan.innerHTML = tides || 'No tide data for today';
        })
        .catch(error => {
          console.error('Tide API fetch error:', error);
          tideDataSpan.innerHTML = 'Tide data unavailable. Try again.';
        });
    }

    // Tide toggle functionality
    let isTideEnabled = false;
    const tideToggleButton = document.getElementById('tide-toggle');
    const tideInfo = document.getElementById('tide-info');

    function updateTideToggleButton() {
      if (isTideEnabled) {
        tideToggleButton.textContent = 'Tide Info On';
        tideToggleButton.classList.remove('off');
        tideToggleButton.setAttribute('aria-label', 'Turn tide information off');
      } else {
        tideToggleButton.textContent = 'Tide Info Off';
        tideToggleButton.classList.add('off');
        tideToggleButton.setAttribute('aria-label', 'Turn tide information on');
        tideInfo.style.display = 'none';
      }
    }

    tideToggleButton.addEventListener('click', () => {
      isTideEnabled = !isTideEnabled;
      updateTideToggleButton();
    });

    updateTideToggleButton();

    // Map click event to fetch tide data only when tide is enabled
    map.on('click', function(e) {
      if (isTideEnabled) {
        const lat = e.latlng.lat;
        const long = e.latlng.lng;
        tideInfo.style.display = 'block';
        fetchTideData(lat, long);
      }
    });

    // Shared functionality for distribution layers
    const distributionColors = {
      '1': '#FF0000', // Red for Type 1
      '2': '#0000FF', // Blue for Type 2
      '3': '#00FF00', // Green for Type 3
      '4': '#FFFF00'  // Yellow for Type 4
    };

    let distTypeProperty = 'distribution type'; // Default property name

    function getFeatureStyle(feature) {
      const props = feature.properties || {};
      const distType = props[distTypeProperty] ? String(props[distTypeProperty]) : null;
      const color = distType && distributionColors[distType] ? distributionColors[distType] : '#6666ff'; // Fallback to light blue

      return {
        color: color,
        weight: 2,
        opacity: 0.8,
        fillColor: color,
        fillOpacity: 0.4
      };
    }

    function createLegend(species) {
      const legend = L.control({ position: 'bottomright' });
      legend.onAdd = function () {
        const div = L.DomUtil.create('div', 'leaflet-control-legend');
        div.innerHTML = `<strong>${species} Annual Distribution</strong><br>`;
        const typeLabels = {
          '1': 'Hot Spot',
          '2': 'Normal Range (90%)',
          '3': 'Full Range (100%)',
          '4': 'Known Not to Exist'
        };
        Object.keys(distributionColors).forEach(type => {
          div.innerHTML += `
            <div class="legend-item">
              <div class="legend-color" style="background-color: ${distributionColors[type]};"></div>
              <span>${typeLabels[type] || `Type ${type}`}</span>
            </div>
          `;
        });
        return div;
      };
      return legend;
    }

    function loadDistributionLayer(url, layer, species, toggleButton, legend, isEnabled, uniqueDistTypes) {
      fetch(url)
        .then(response => {
          if (!response.ok) {
            console.error(`Failed to load ${species} GeoJSON: HTTP ${response.status} - ${response.statusText}`);
            alert(`Failed to load ${species} distribution data. Please check the GeoJSON file URL.`);
            return null;
          }
          return response.json();
        })
        .then(data => {
          if (data) {
            if (!data.features || data.features.length === 0) {
              console.error(`${species} GeoJSON contains no features`);
              alert(`${species} distribution GeoJSON is empty or invalid.`);
              return;
            }
            console.log(`Number of features in ${species} GeoJSON:`, data.features.length);
            const sampleFeature = data.features[0];
            const props = sampleFeature.properties || {};
            const propNames = Object.keys(props);
            const possibleDistKeys = propNames.filter(key => 
              key.toLowerCase().includes('dist') || key.toLowerCase().includes('type')
            );
            console.log(`Possible distribution type keys for ${species}:`, possibleDistKeys);
            const likelyKey = possibleDistKeys.find(key => key.toLowerCase().includes('dist') && key.toLowerCase().includes('type')) || 'distribution type';
            if (likelyKey !== distTypeProperty) {
              console.log(`Updating distribution type property for ${species} to: ${likelyKey}`);
              distTypeProperty = likelyKey;
            }
            layer.addData(data);
            console.log(`Features added to ${species} layer:`, layer.getLayers().length);
            updateToggleButton();
            console.log(`${species} GeoJSON loaded successfully:`, data);
            console.log(`Unique distribution types for ${species}:`, Array.from(uniqueDistTypes));
            // Log bounds for debugging, but don't use for zooming
            try {
              const bounds = layer.getBounds();
              if (bounds.isValid()) {
                console.log(`${species} GeoJSON bounds:`, bounds.toBBoxString());
              } else {
                console.warn(`Invalid ${species} GeoJSON bounds`);
              }
            } catch (error) {
              console.error(`Error computing ${species} GeoJSON bounds:`, error);
            }
          }
        })
        .catch(error => {
          console.error(`Error fetching ${species} GeoJSON:`, error);
          alert(`Error loading ${species} distribution data. Please try again later.`);
        });

      function updateToggleButton() {
        if (isEnabled) {
          toggleButton.textContent = `${species} Dist On`;
          toggleButton.classList.remove('off');
          toggleButton.setAttribute('aria-label', `Turn ${species} distribution off`);
          map.addLayer(layer);
          legend.addTo(map);
        } else {
          toggleButton.textContent = `${species} Dist Off`;
          toggleButton.classList.add('off');
          toggleButton.setAttribute('aria-label', `Turn ${species} distribution on`);
          map.removeLayer(layer);
          map.removeControl(legend);
        }
      }

      toggleButton.addEventListener('click', () => {
        isEnabled = !isEnabled;
        updateToggleButton();
        if (isEnabled) {
          // Always center on Wellington when toggling on
          map.setView([-41.313, 174.77], 11);
        }
      });

      updateToggleButton();
    }

    // Snapper distribution layer
    let isSnapperEnabled = false;
    let snapperLayer;
    const snapperUniqueDistTypes = new Set();

    snapperLayer = L.geoJSON(null, {
      style: getFeatureStyle,
      onEachFeature: function (feature, layer) {
        const props = feature.properties || {};
        console.log('Snapper GeoJSON Feature Properties:', props);
        const propNames = Object.keys(props);
        console.log('Property names in Snapper feature:', propNames);
        const distType = props[distTypeProperty] ? String(props[distTypeProperty]) : null;
        if (distType) {
          snapperUniqueDistTypes.add(distType);
          console.log(`Snapper Feature distribution type (${distTypeProperty}): ${distType}, Color: ${distributionColors[distType] || '#6666ff'}`);
        } else {
          console.warn(`Missing or invalid "${distTypeProperty}" for Snapper feature:`, props);
        }
        if (props) {
          let popupContent = '<strong>Snapper Annual Distribution</strong><br>';
          const desiredProps = [
            'PortalUrl',
            'ObjectReferences',
            'SpeciesDepthMaximum',
            'ScientificContact',
            'SpeciesScientificName',
            'SpeciesMaoriName',
            'TemporalExtent',
            'SpeciesDepthMinimum',
            'SpeciesGroup',
            'HabitatType'
          ];
          desiredProps.forEach(prop => {
            if (props[prop] !== undefined && props[prop] !== null) {
              popupContent += `${prop}: ${props[prop]}<br>`;
            }
          });
          layer.bindPopup(popupContent);
        }
      }
    }).addTo(map);

    const snapperLegend = createLegend('Snapper');
    const snapperToggleButton = document.getElementById('snapper-toggle');

    loadDistributionLayer(
      'https://raw.githubusercontent.com/khandangit/wellyfishing/main/Red_Snapper_-_Annual_Distribution.geojson',
      snapperLayer,
      'Snapper',
      snapperToggleButton,
      snapperLegend,
      isSnapperEnabled,
      snapperUniqueDistTypes
    );

    // Kingfish distribution layer
    let isKingfishEnabled = false;
    let kingfishLayer;
    const kingfishUniqueDistTypes = new Set();

    kingfishLayer = L.geoJSON(null, {
      style: getFeatureStyle,
      onEachFeature: function (feature, layer) {
        const props = feature.properties || {};
        console.log('Kingfish GeoJSON Feature Properties:', props);
        const propNames = Object.keys(props);
        console.log('Property names in Kingfish feature:', propNames);
        const distType = props[distTypeProperty] ? String(props[distTypeProperty]) : null;
        if (distType) {
          kingfishUniqueDistTypes.add(distType);
          console.log(`Kingfish Feature distribution type (${distTypeProperty}): ${distType}, Color: ${distributionColors[distType] || '#6666ff'}`);
        } else {
          console.warn(`Missing or invalid "${distTypeProperty}" for Kingfish feature:`, props);
        }
        if (props) {
          let popupContent = '<strong>Kingfish Annual Distribution</strong><br>';
          const desiredProps = [
            'PortalUrl',
            'ObjectReferences',
            'SpeciesDepthMaximum',
            'ScientificContact',
            'SpeciesScientificName',
            'SpeciesMaoriName',
            'TemporalExtent',
            'SpeciesDepthMinimum',
            'SpeciesGroup',
            'HabitatType'
          ];
          desiredProps.forEach(prop => {
            if (props[prop] !== undefined && props[prop] !== null) {
              popupContent += `${prop}: ${props[prop]}<br>`;
            }
          });
          layer.bindPopup(popupContent);
        }
      }
    }).addTo(map);

    const kingfishLegend = createLegend('Kingfish');
    const kingfishToggleButton = document.getElementById('kingfish-toggle');

    loadDistributionLayer(
      'https://raw.githubusercontent.com/khandangit/wellyfishing/main/Kingfish_-_Annual_Distribution.geojson',
      kingfishLayer,
      'Kingfish',
      kingfishToggleButton,
      kingfishLegend,
      isKingfishEnabled,
      kingfishUniqueDistTypes
    );

    // Kahawai distribution layer
    let isKahawaiEnabled = false;
    let kahawaiLayer;
    const kahawaiUniqueDistTypes = new Set();

    kahawaiLayer = L.geoJSON(null, {
      style: getFeatureStyle,
      onEachFeature: function (feature, layer) {
        const props = feature.properties || {};
        console.log('Kahawai GeoJSON Feature Properties:', props);
        const propNames = Object.keys(props);
        console.log('Property names in Kahawai feature:', propNames);
        const distType = props[distTypeProperty] ? String(props[distTypeProperty]) : null;
        if (distType) {
          kahawaiUniqueDistTypes.add(distType);
          console.log(`Kahawai Feature distribution type (${distTypeProperty}): ${distType}, Color: ${distributionColors[distType] || '#6666ff'}`);
        } else {
          console.warn(`Missing or invalid "${distTypeProperty}" for Kahawai feature:`, props);
        }
        if (props) {
          let popupContent = '<strong>Kahawai Annual Distribution</strong><br>';
          const desiredProps = [
            'PortalUrl',
            'ObjectReferences',
            'SpeciesDepthMaximum',
            'ScientificContact',
            'SpeciesScientificName',
            'SpeciesMaoriName',
            'TemporalExtent',
            'SpeciesDepthMinimum',
            'SpeciesGroup',
            'HabitatType'
          ];
          desiredProps.forEach(prop => {
            if (props[prop] !== undefined && props[prop] !== null) {
              popupContent += `${prop}: ${props[prop]}<br>`;
            }
          });
          layer.bindPopup(popupContent);
        }
      }
    }).addTo(map);

    const kahawaiLegend = createLegend('Kahawai');
    const kahawaiToggleButton = document.getElementById('kahawai-toggle');

    loadDistributionLayer(
      'https://raw.githubusercontent.com/khandangit/wellyfishing/main/Kahawai_-_Annual_Distribution.geojson',
      kahawaiLayer,
      'Kahawai',
      kahawaiToggleButton,
      kahawaiLegend,
      isKahawaiEnabled,
      kahawaiUniqueDistTypes
    );

    // Red Cod distribution layer
    let isRedCodEnabled = false;
    let redCodLayer;
    const redCodUniqueDistTypes = new Set();

    redCodLayer = L.geoJSON(null, {
      style: getFeatureStyle,
      onEachFeature: function (feature, layer) {
        const props = feature.properties || {};
        console.log('Red Cod GeoJSON Feature Properties:', props);
        const propNames = Object.keys(props);
        console.log('Property names in Red Cod feature:', propNames);
        const distType = props[distTypeProperty] ? String(props[distTypeProperty]) : null;
        if (distType) {
          redCodUniqueDistTypes.add(distType);
          console.log(`Red Cod Feature distribution type (${distTypeProperty}): ${distType}, Color: ${distributionColors[distType] || '#6666ff'}`);
        } else {
          console.warn(`Missing or invalid "${distTypeProperty}" for Red Cod feature:`, props);
        }
        if (props) {
          let popupContent = '<strong>Red Cod Annual Distribution</strong><br>';
          const desiredProps = [
            'PortalUrl',
            'ObjectReferences',
            'SpeciesDepthMaximum',
            'ScientificContact',
            'SpeciesScientificName',
            'SpeciesMaoriName',
            'TemporalExtent',
            'SpeciesDepthMinimum',
            'SpeciesGroup',
            'HabitatType'
          ];
          desiredProps.forEach(prop => {
            if (props[prop] !== undefined && props[prop] !== null) {
              popupContent += `${prop}: ${props[prop]}<br>`;
            }
          });
          layer.bindPopup(popupContent);
        }
      }
    }).addTo(map);

    const redCodLegend = createLegend('Red Cod');
    const redCodToggleButton = document.getElementById('redcod-toggle');

    loadDistributionLayer(
      'https://raw.githubusercontent.com/khandangit/wellyfishing/main/Red_Cod_-_Annual_Distribution.geojson',
      redCodLayer,
      'Red Cod',
      redCodToggleButton,
      redCodLegend,
      isRedCodEnabled,
      redCodUniqueDistTypes
    );

    document.addEventListener('DOMContentLoaded', () => {
      // Form submission confirmation
      const form = document.getElementById('submit-spot-form');
      const confirmationMessage = document.getElementById('confirmation-message');

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = document.getElementById('spot-name').value;
        const coords = document.getElementById('spot-coords').value;
        const fish = document.getElementById('spot-fish').value;
        const tips = document.getElementById('spot-tips').value;
        const season = document.getElementById('spot-season').value;

        const emailBody = `
          New Fishing Spot Submission:
          Name: ${name}
          Coordinates: ${coords}
          Fish: ${fish}
          Tips: ${tips}
          Best Season: ${season}
        `.replace(/\n\s+/g, '\n');

        const mailtoLink = `mailto:khandangithub@gmail.com?subject=New Fishing Spot Submission&body=${encodeURIComponent(emailBody)}`;
        window.location.href = mailtoLink;

        // Show confirmation message
        confirmationMessage.style.display = 'block';
        setTimeout(() => {
          confirmationMessage.style.display = 'none';
        }, 3000);

        form.reset();
      });
    });
  </script>
</body>
</html>
